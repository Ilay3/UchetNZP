@using System.Globalization
@model WarehouseIndexViewModel
@{
    ViewData["Title"] = "Склад НЗП";
}

<div class="page-header glass-panel mb-4">
    <h1 class="display-5 fw-semibold">Склад НЗП</h1>
    <p class="lead mb-0">Просматривайте остатки деталей на складе и при необходимости корректируйте запись.</p>
</div>

@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.StatusMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
    </div>
}

<div class="card glass-panel shadow-sm mb-4">
    <div class="card-header fw-semibold">Фильтр</div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-6">
                <label class="form-label" for="warehousePartSelect">Деталь</label>
                <select id="warehousePartSelect" class="form-select" name="partId" asp-items="Model.Parts"></select>
            </div>
            <div class="col-lg-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">Применить</button>
                <a class="btn btn-outline-secondary" asp-action="Index">Сбросить</a>
            </div>
            <div class="col-lg-3 text-lg-end">
                <span class="text-muted">Всего на складе: <span class="fw-semibold">@Model.TotalQuantity.ToString("0.###", CultureInfo.CurrentCulture)</span> шт</span>
            </div>
        </form>
    </div>
</div>

<div class="card glass-panel shadow-sm">
    <div class="card-header fw-semibold">Записи склада</div>
    <div class="card-body">
        @if (Model.PartGroups.Count == 0)
        {
            <div class="text-muted">Записей не найдено.</div>
        }
        else
        {
            var accordionId = "warehouseAccordion";
            var accordionIndex = 0;

            <div class="accordion" id="@accordionId">
                @foreach (var partGroup in Model.PartGroups)
                {
                    var collapseId = $"warehouse-collapse-{accordionIndex}";
                    var headingId = $"warehouse-heading-{accordionIndex}";
                    var labelCount = partGroup.LabelGroups.Count;
                    var itemCount = partGroup.Items.Count;
                    accordionIndex++;

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="@headingId">
                            <button class="accordion-button collapsed d-flex flex-column flex-lg-row align-items-lg-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                <span class="flex-grow-1 text-start">
                                    <span class="fw-semibold">@partGroup.PartDisplay</span>
                                    <span class="d-block small text-muted">Ярлыков: @labelCount • Записей: @itemCount</span>
                                </span>
                                <span class="badge bg-primary text-uppercase">
                                    Всего: @partGroup.TotalQuantity.ToString("0.###", CultureInfo.CurrentCulture)
                                </span>
                            </button>
                        </h2>
                        <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="@headingId" data-bs-parent="#@accordionId">
                            <div class="accordion-body">
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                        <h6 class="mb-0">Ярлыки детали</h6>
                                        <small class="text-muted">Всего: @labelCount</small>
                                    </div>
                                    @if (labelCount == 0)
                                    {
                                        <div class="text-muted">Для этой детали нет привязанных ярлыков.</div>
                                    }
                                    else
                                    {
                                        <div class="table-responsive glass-table">
                                            <table class="table table-sm align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Номер</th>
                                                        <th scope="col" class="text-end">Количество</th>
                                                        <th scope="col">Дата добавления</th>
                                                        <th scope="col">Обновлено</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var label in partGroup.LabelGroups)
                                                    {
                                                        <tr>
                                                            <td class="fw-semibold">
                                                                @if (string.IsNullOrWhiteSpace(label.LabelNumber))
                                                                {
                                                                    <span class="text-muted">—</span>
                                                                }
                                                                else
                                                                {
                                                                    @label.LabelNumber
                                                                }
                                                            </td>
                                                            <td class="text-end">@label.TotalQuantity.ToString("0.###", CultureInfo.CurrentCulture)</td>
                                                            <td>@label.FirstAddedAt.ToLocalTime().ToString("dd.MM.yyyy", CultureInfo.CurrentCulture)</td>
                                                            <td>
                                                                @if (label.LastUpdatedAt.HasValue)
                                                                {
                                                                    @label.LastUpdatedAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm", CultureInfo.CurrentCulture)
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">—</span>
                                                                }
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                </div>

                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                    <h6 class="mb-0">Записи склада</h6>
                                    <small class="text-muted">Всего: @itemCount</small>
                                </div>

                                @if (itemCount == 0)
                                {
                                    <div class="text-muted">Для этой детали нет записей на складе.</div>
                                }
                                else
                                {
                                    <div class="row g-3">
                                        @foreach (var row in partGroup.Items)
                                        {
                                            <div class="col-12">
                                                <div class="border rounded p-3 bg-white h-100">
                                                    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-3">
                                                        <div>
                                                            <div class="fw-semibold">Запись от @row.AddedAt.ToLocalTime().ToString("dd.MM.yyyy", CultureInfo.CurrentCulture)</div>
                                                            <div class="text-muted small">
                                                                @if (row.UpdatedAt.HasValue)
                                                                {
                                                                    <text> • Обновлено: @row.UpdatedAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm", CultureInfo.CurrentCulture)</text>
                                                                }
                                                            </div>
                                                            @if (string.IsNullOrWhiteSpace(row.Comment))
                                                            {
                                                                <div class="text-muted small fst-italic mt-1">Комментарий не указан.</div>
                                                            }
                                                            else
                                                            {
                                                                <div class="small mt-1">Комментарий: @row.Comment</div>
                                                            }
                                                        </div>
                                                        <div class="text-lg-end">
                                                            <div class="fs-3 fw-semibold">@row.Quantity.ToString("0.###", CultureInfo.CurrentCulture)</div>
                                                            <div class="text-muted small">Количество, шт</div>
                                                        </div>
                                                    </div>
                                                    <form asp-action="Update" method="post" class="row g-2 g-lg-3 align-items-end">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="Id" value="@row.Id" />
                                                        <input type="hidden" name="FilterPartId" value="@Model.SelectedPartId" />
                                                        <div class="col-12 col-md-4 col-lg-3">
                                                            <label class="form-label" for="qty-@row.Id">Количество</label>
                                                            <input id="qty-@row.Id" class="form-control" type="number" name="Quantity" value='@row.Quantity.ToString("0.###", CultureInfo.InvariantCulture)' min="0" step="0.001" />
                                                        </div>
                                                        <div class="col-12 col-md-4 col-lg-3">
                                                            <label class="form-label" for="date-@row.Id">Дата</label>
                                                            <input id="date-@row.Id" class="form-control" type="date" name="AddedAt" value="@row.AddedAt.ToLocalTime().ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)" />
                                                        </div>
                                                        <div class="col-12 col-md-4 col-lg-4">
                                                            <label class="form-label" for="comment-@row.Id">Комментарий</label>
                                                            <input id="comment-@row.Id" class="form-control" type="text" name="Comment" maxlength="512" value="@(row.Comment ?? string.Empty)" placeholder="Комментарий" />
                                                        </div>
                                                        <div class="col-12 col-lg-2 d-flex gap-2 justify-content-end">
                                                            <button type="submit" class="btn btn-primary">Сохранить</button>
                                                            <button type="reset" class="btn btn-outline-secondary">Отмена</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>
