@model UchetNZP.Web.Models.WipHistoryViewModel
@using UchetNZP.Web.Models
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using Microsoft.AspNetCore.Mvc
@using Microsoft.AspNetCore.WebUtilities
@{
    ViewData["Title"] = "История операций НЗП";
    var types = new[]
    {
        WipHistoryEntryType.Launch,
        WipHistoryEntryType.Receipt,
        WipHistoryEntryType.Transfer
    };
    var pageSizes = new[] { 10, 20, 50, 100 };
    var hasCustomPageSize = !pageSizes.Contains(Model.PageSize);
}

@functions {
    private static string getTypeValue(WipHistoryEntryType in_type)
    {
        var ret = string.Empty;
        switch (in_type)
        {
            case WipHistoryEntryType.Launch:
                ret = "launch";
                break;
            case WipHistoryEntryType.Receipt:
                ret = "receipt";
                break;
            case WipHistoryEntryType.Transfer:
                ret = "transfer";
                break;
        }

        return ret;
    }

    private static string getTypeBadgeClass(WipHistoryEntryType in_type)
    {
        var ret = "bg-secondary";
        switch (in_type)
        {
            case WipHistoryEntryType.Launch:
                ret = "bg-primary";
                break;
            case WipHistoryEntryType.Receipt:
                ret = "bg-success";
                break;
            case WipHistoryEntryType.Transfer:
                ret = "bg-warning text-dark";
                break;
        }

        return ret;
    }

    private static string getTypeDisplayName(WipHistoryEntryType in_type)
    {
        var ret = "Операции";
        switch (in_type)
        {
            case WipHistoryEntryType.Launch:
                ret = "Запуски";
                break;
            case WipHistoryEntryType.Receipt:
                ret = "Приходы";
                break;
            case WipHistoryEntryType.Transfer:
                ret = "Передачи";
                break;
        }

        return ret;
    }

    private static IDictionary<string, string?> createBaseQuery(WipHistoryViewModel in_model)
    {
        var ret = new Dictionary<string, string?>
        {
            ["from"] = in_model.Filter.From.ToString("yyyy-MM-dd"),
            ["to"] = in_model.Filter.To.ToString("yyyy-MM-dd"),
            ["part"] = in_model.Filter.PartSearch,
            ["section"] = in_model.Filter.SectionSearch,
            ["pageSize"] = in_model.PageSize.ToString(CultureInfo.InvariantCulture)
        };

        return ret;
    }

    private static string buildPageUrl(IUrlHelper in_urlHelper, WipHistoryViewModel in_model, int in_page)
    {
        var ret = string.Empty;
        var baseUrl = in_urlHelper.Action("Index", "WipHistory");
        if (!string.IsNullOrWhiteSpace(baseUrl))
        {
            var targetPage = in_page;
            if (targetPage < 1)
            {
                targetPage = 1;
            }
            else if (in_model.TotalPages > 0 && targetPage > in_model.TotalPages)
            {
                targetPage = in_model.TotalPages;
            }

            var routeValues = createBaseQuery(in_model);
            routeValues["page"] = targetPage.ToString(CultureInfo.InvariantCulture);

            ret = QueryHelpers.AddQueryString(baseUrl, routeValues);
            if (in_model.Filter.Types.Count > 0)
            {
                var typeValues = in_model.Filter.Types
                    .Select(getTypeValue)
                    .ToArray();
                ret = QueryHelpers.AddQueryString(ret, "types", typeValues);
            }
        }

        return ret;
    }
}

<h2 class="mb-4">История операций НЗП</h2>

<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end" autocomplete="off">
            <input type="hidden" name="page" value="1" />
            <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="historyFilterFrom">Период с</label>
                <input id="historyFilterFrom" class="form-control" type="date" name="from" value="@Model.Filter.From.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="historyFilterTo">по</label>
                <input id="historyFilterTo" class="form-control" type="date" name="to" value="@Model.Filter.To.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="historyFilterPart">Деталь</label>
                <input id="historyFilterPart" class="form-control" type="text" name="part" value="@Model.Filter.PartSearch" placeholder="Название или код" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="historyFilterSection">Вид работ</label>
                <input id="historyFilterSection" class="form-control" type="text" name="section" value="@Model.Filter.SectionSearch" placeholder="Участок или код" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="historyFilterPageSize">На странице</label>
                <select id="historyFilterPageSize" class="form-select" name="pageSize">
                    @foreach (var size in pageSizes)
                    {
                        if (Model.PageSize == size)
                        {
                            <option value="@size" selected="selected">@size</option>
                        }
                        else
                        {
                            <option value="@size">@size</option>
                        }
                    }
                    if (hasCustomPageSize)
                    {
                        <option value="@Model.PageSize" selected="selected">@Model.PageSize</option>
                    }
                </select>
            </div>
            <div class="col-sm-6 col-lg-3">
                <button type="submit" class="btn btn-primary w-100">Показать</button>
            </div>
            <div class="col-12">
                <div class="fw-semibold mb-2">Типы операций</div>
                <div class="d-flex flex-wrap gap-3">
                    @foreach (var type in types)
                    {
                        var value = getTypeValue(type);
                        var inputId = $"historyFilterType_{value}";
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="@inputId" name="types" value="@value" @(Model.Filter.IsTypeSelected(type) ? "checked" : string.Empty) />
                            <label class="form-check-label" for="@inputId">@getTypeDisplayName(type)</label>
                        </div>
                    }
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.HasData)
{
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="border rounded p-3 h-100">
                <div class="text-muted small">Всего записей</div>
                <div class="h3 mb-2">@Model.TotalEntries</div>
                <div class="text-muted small">На странице: @Model.PageEntryCount</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="border rounded p-3 h-100">
                <div class="text-muted small">Всего количество, шт</div>
                <div class="h3 mb-2">@Model.TotalQuantity.ToString("0.###")</div>
                <div class="text-muted small">На странице: @Model.PageQuantity.ToString("0.###")</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="border rounded p-3 h-100">
                <div class="text-muted small">Период</div>
                <div class="h3 mb-0">@Model.Filter.From.ToString("dd.MM.yyyy") — @Model.Filter.To.ToString("dd.MM.yyyy")</div>
            </div>
        </div>
    </div>

    @if (Model.HasPagination)
    {
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
            <div class="text-muted">Страница @Model.CurrentPage из @Model.TotalPages</div>
            <nav aria-label="Навигация страниц">
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : string.Empty)">
                        <a class="page-link" href="@buildPageUrl(Url, Model, Model.CurrentPage - 1)">Назад</a>
                    </li>
                    @for (var page = 1; page <= Model.TotalPages; page++)
                    {
                        <li class="page-item @(page == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" href="@buildPageUrl(Url, Model, page)">@page</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link" href="@buildPageUrl(Url, Model, Model.CurrentPage + 1)">Вперёд</a>
                    </li>
                </ul>
            </nav>
        </div>
    }

    @foreach (var group in Model.Groups)
    {
        <div class="card mb-3">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                <div>
                    <div class="fw-semibold">@group.Date.ToString("dd.MM.yyyy")</div>
                    <div class="text-muted small">Записей: @group.EntryCount • Количество: @group.TotalQuantity.ToString("0.###") шт</div>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var summary in group.Summaries)
                    {
                        <span class="badge bg-light text-dark border">@summary.TypeDisplayName: @summary.Count (@summary.Quantity.ToString("0.###"))</span>
                    }
                </div>
            </div>
            <div class="list-group list-group-flush">
                @foreach (var entry in group.Entries)
                {
                    <div class="list-group-item">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3">
                            <div class="flex-grow-1">
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <span class="badge @getTypeBadgeClass(entry.Type)">@entry.TypeDisplayName</span>
                                    @if (!string.IsNullOrWhiteSpace(entry.OperationRange))
                                    {
                                        <span class="badge bg-light text-dark border">@entry.OperationRange</span>
                                    }
                                </div>
                                <div class="fw-semibold">@entry.PartDisplayName</div>

                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    @if (!string.IsNullOrWhiteSpace(entry.SectionName))
                                    {
                                        <span class="badge bg-light text-dark border">От: @entry.SectionName</span>
                                    }
                                    @if (entry.HasTargetSection)
                                    {
                                        <span class="badge bg-light text-dark border">В: @entry.TargetSectionName</span>
                                    }
                                    @if (entry.HasLabel)
                                    {
                                        <span class="badge bg-light text-dark border">Ярлык: @entry.LabelNumber</span>
                                    }
                                </div>
                                @if (entry.HasComment)
                                {
                                    <div class="mt-2">
                                        <span class="fw-semibold">Комментарий:</span>
                                        <span>@entry.Comment</span>
                                    </div>
                                }
                                @if (entry.HasScrap && entry.Scrap is not null)
                                {
                                    <div class="alert alert-warning mt-3 mb-0" role="alert">
                                        <div class="fw-semibold">@entry.Scrap.Type — @entry.Scrap.Quantity.ToString("0.###") шт</div>
                                        @if (entry.Scrap.HasComment)
                                        {
                                            <div class="small text-muted">@entry.Scrap.Comment</div>
                                        }
                                    </div>
                                }
                                @if (entry.HasOperations)
                                {
                                    <details class="mt-3">
                                        <summary class="small text-muted">Детали операций</summary>
                                        <ul class="small mt-2 mb-0">
                                            @foreach (var operation in entry.Operations)
                                            {
                                                var parts = new List<string>();
                                                parts.Add($"№ {operation.OpNumber}");
                                                if (!string.IsNullOrWhiteSpace(operation.OperationName))
                                                {
                                                    parts.Add(operation.OperationName);
                                                }
                                                if (!string.IsNullOrWhiteSpace(operation.SectionName))
                                                {
                                                    parts.Add($"Вид работ: {operation.SectionName}");
                                                }
                                                if (operation.HasNormHours)
                                                {
                                                    parts.Add($"Норматив: {operation.NormHours!.Value.ToString("0.###")}");
                                                }
                                                if (operation.HasHours)
                                                {
                                                    parts.Add($"Часы: {operation.Hours!.Value.ToString("0.###")}");
                                                }
                                                if (operation.HasQuantityChange)
                                                {
                                                    parts.Add($"Δ количество: {operation.QuantityChange!.Value.ToString("0.###")}");
                                                }
                                                <li>@string.Join(" • ", parts)</li>
                                            }
                                        </ul>
                                    </details>
                                }
                            </div>
                            <div class="text-md-end">
                                <div class="fw-semibold">@entry.Quantity.ToString("0.###") шт</div>
                                @if (entry.HasHours)
                                {
                                    <div class="text-muted">Часы: @entry.Hours!.Value.ToString("0.###")</div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (Model.HasPagination)
    {
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-3">
            <div class="text-muted">Страница @Model.CurrentPage из @Model.TotalPages</div>
            <nav aria-label="Навигация страниц">
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : string.Empty)">
                        <a class="page-link" href="@buildPageUrl(Url, Model, Model.CurrentPage - 1)">Назад</a>
                    </li>
                    @for (var page = 1; page <= Model.TotalPages; page++)
                    {
                        <li class="page-item @(page == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" href="@buildPageUrl(Url, Model, page)">@page</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link" href="@buildPageUrl(Url, Model, Model.CurrentPage + 1)">Вперёд</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
}
else
{
    <div class="alert alert-light border">За выбранный период данные отсутствуют.</div>
}

<div class="d-flex justify-content-end mt-4">
    <a class="btn btn-link" asp-controller="Home" asp-action="Index">← На главную</a>
</div>
