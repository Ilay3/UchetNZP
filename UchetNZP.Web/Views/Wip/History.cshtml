@model UchetNZP.Web.Models.WipHistoryViewModel
@using UchetNZP.Web.Models
@using System.Collections.Generic
@using System.Globalization
@{ 
    ViewData["Title"] = "История операций НЗП";
    var types = new[]
    {
        WipHistoryEntryType.Launch,
        WipHistoryEntryType.Receipt,
        WipHistoryEntryType.Transfer
    };
}

@functions {
    private static string GetTypeValue(WipHistoryEntryType type)
    {
        return type switch
        {
            WipHistoryEntryType.Launch => "launch",
            WipHistoryEntryType.Receipt => "receipt",
            WipHistoryEntryType.Transfer => "transfer",
            _ => string.Empty,
        };
    }

    private static string GetTypeBadgeClass(WipHistoryEntryType type)
    {
        return type switch
        {
            WipHistoryEntryType.Launch => "bg-primary",
            WipHistoryEntryType.Receipt => "bg-success",
            WipHistoryEntryType.Transfer => "bg-warning text-dark",
            _ => "bg-secondary",
        };
    }

    private static string GetTypeDisplayName(WipHistoryEntryType type)
    {
        return type switch
        {
            WipHistoryEntryType.Launch => "Запуски",
            WipHistoryEntryType.Receipt => "Приходы",
            WipHistoryEntryType.Transfer => "Передачи",
            _ => "Операции",
        };
    }

    private static bool HasTimeComponent(DateTime value)
    {
        return value.TimeOfDay != TimeSpan.Zero;
    }
}

<div class="page-header mb-4">
    <h1 class="display-5 fw-semibold">История операций НЗП</h1>
    <p class="lead">Анализируйте запуски, приходы и передачи по датам с единым фильтром и подробными деталями.</p>
</div>

<div id="wipHistoryRoot" data-page="wip-history">
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end" autocomplete="off">
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label class="form-label" for="historyFilterFrom">Период с</label>
                <input id="historyFilterFrom" class="form-control form-control-lg" type="date" name="from" value="@Model.Filter.From.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label class="form-label" for="historyFilterTo">по</label>
                <input id="historyFilterTo" class="form-control form-control-lg" type="date" name="to" value="@Model.Filter.To.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-sm-6 col-md-3 col-lg-3">
                <label class="form-label" for="historyFilterPart">Деталь</label>
                <input id="historyFilterPart" class="form-control form-control-lg" type="text" name="part" value="@Model.Filter.PartSearch" placeholder="Название или код" />
            </div>
            <div class="col-sm-6 col-md-3 col-lg-3">
                <label class="form-label" for="historyFilterSection">Вид работ</label>
                <input id="historyFilterSection" class="form-control form-control-lg" type="text" name="section" value="@Model.Filter.SectionSearch" placeholder="Участок или код" />
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">Показать</button>
            </div>
            <div class="col-12">
                <div class="fw-semibold mb-2">Типы операций</div>
                <div class="d-flex flex-wrap gap-3">
                    @foreach (var type in types)
                    {
                        var value = GetTypeValue(type);
                        var inputId = $"historyFilterType_{value}";
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="@inputId" name="types" value="@value" @(Model.Filter.IsTypeSelected(type) ? "checked" : string.Empty) />
                            <label class="form-check-label" for="@inputId">@GetTypeDisplayName(type)</label>
                        </div>
                    }
                </div>
                <div class="form-text">Снимите галочки, чтобы исключить отдельные типы из списка.</div>
            </div>
        </form>
    </div>
</div>

<div class="alert alert-info d-none" id="historyActionFeedback" role="alert"></div>

@if (Model.HasData)
{
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row text-center gy-3">
                <div class="col-md-4">
                    <div class="text-muted text-uppercase small fw-semibold">Количество записей</div>
                    <div class="fs-4 fw-semibold" id="historyTotalEntriesValue">@Model.TotalEntries</div>
                </div>
                <div class="col-md-4">
                    <div class="text-muted text-uppercase small fw-semibold">Суммарное количество, шт</div>
                    <div class="fs-4 fw-semibold" id="historyTotalQuantityValue">@Model.TotalQuantity.ToString("0.###")</div>
                </div>
                <div class="col-md-4">
                    <div class="text-muted text-uppercase small fw-semibold">Выбранный период</div>
                    <div class="fw-semibold" id="historySelectedPeriod">@Model.Filter.From.ToString("dd.MM.yyyy") — @Model.Filter.To.ToString("dd.MM.yyyy")</div>
                </div>
            </div>
        </div>
    </div>

    @foreach (var group in Model.Groups)
    {
        var groupDate = group.Date.ToString("yyyy-MM-dd");
        <div class="card shadow-sm mb-4 js-history-group" data-group-date="@groupDate">
            <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div>
                    <div class="h4 mb-1">@group.Date.ToString("dd.MM.yyyy")</div>
                    <div class="text-muted small">
                        Записей: <span class="js-history-group-count" data-group-date="@groupDate">@group.EntryCount</span> • Количество: <span class="js-history-group-quantity" data-group-date="@groupDate">@group.TotalQuantity.ToString("0.###")</span> шт
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var summary in group.Summaries)
                    {
                        var summaryType = GetTypeValue(summary.Type);
                        <span class="badge bg-secondary-subtle text-dark border js-history-group-summary" data-group-date="@groupDate" data-summary-type="@summaryType">
                            <span class="js-history-group-summary-name">@summary.TypeDisplayName</span>:
                            <span class="js-history-group-summary-count">@summary.Count</span>
                            (<span class="js-history-group-summary-quantity">@summary.Quantity.ToString("0.###")</span>)
                        </span>
                    }
                </div>
            </div>
            <div class="list-group list-group-flush">
                @foreach (var entry in group.Entries)
                {
                    var entryType = GetTypeValue(entry.Type);
                    var hasActions = (entry.Type == WipHistoryEntryType.Transfer && entry.HasVersions && entry.AuditId.HasValue) || entry.Type == WipHistoryEntryType.Receipt;
                    var hasEntryDetails = !string.IsNullOrWhiteSpace(entry.SectionName)
                        || entry.HasTargetSection
                        || entry.HasLabel
                        || !string.IsNullOrWhiteSpace(entry.OperationRange)
                        || entry.HasComment
                        || entry.HasScrap
                        || entry.HasOperations
                        || entry.HasHours
                        || hasActions;
                    <div class="list-group-item py-3 js-history-entry"
                         data-entry-id="@entry.Id"
                         data-entry-type="@entryType"
                         data-quantity="@entry.Quantity.ToString("0.###", CultureInfo.InvariantCulture)"
                         data-group-date="@groupDate"
                         data-cancelled="@(entry.IsReverted.ToString().ToLowerInvariant())"
                         data-has-versions="@(entry.HasVersions.ToString().ToLowerInvariant())"
                         data-audit-id="@entry.AuditId"
                         data-version-id="@entry.VersionId"
                         data-label-number="@entry.LabelNumber"
                         data-part-name="@entry.PartDisplayName"
                         data-operation-range="@entry.OperationRange">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3">
                            <div class="flex-grow-1">
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <span class="badge @GetTypeBadgeClass(entry.Type)">@entry.TypeDisplayName</span>
                                    <span class="badge @(entry.IsCancelled ? "bg-danger" : "bg-success") js-history-status">@entry.Status</span>
                                </div>
                                <div class="fw-semibold fs-5">@entry.PartDisplayName</div>
                                @if (hasEntryDetails)
                                {
                                    <details class="mt-3">
                                        <summary class="small text-muted">Подробности</summary>
                                        @if (!string.IsNullOrWhiteSpace(entry.SectionName)
                                            || entry.HasTargetSection
                                            || entry.HasLabel
                                            || !string.IsNullOrWhiteSpace(entry.OperationRange))
                                        {
                                            <div class="mt-2">
                                                <div class="text-muted small fw-semibold text-uppercase">Путь детали</div>
                                                <div class="border-start border-2 ps-3 mt-2">
                                                    @if (!string.IsNullOrWhiteSpace(entry.SectionName))
                                                    {
                                                        <div class="d-flex gap-2 align-items-start mb-2">
                                                            <span class="d-inline-block rounded-circle bg-primary" style="width: 0.6rem; height: 0.6rem; margin-top: 0.35rem;"></span>
                                                            <div>
                                                                <div class="small text-muted">От участка</div>
                                                                <div class="fw-semibold">@entry.SectionName</div>
                                                            </div>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrWhiteSpace(entry.OperationRange))
                                                    {
                                                        <div class="d-flex gap-2 align-items-start mb-2">
                                                            <span class="d-inline-block rounded-circle bg-info" style="width: 0.6rem; height: 0.6rem; margin-top: 0.35rem;"></span>
                                                            <div>
                                                                <div class="small text-muted">Диапазон операций</div>
                                                                <div class="fw-semibold">@entry.OperationRange</div>
                                                            </div>
                                                        </div>
                                                    }
                                                    @if (entry.HasTargetSection)
                                                    {
                                                        <div class="d-flex gap-2 align-items-start mb-2">
                                                            <span class="d-inline-block rounded-circle bg-success" style="width: 0.6rem; height: 0.6rem; margin-top: 0.35rem;"></span>
                                                            <div>
                                                                <div class="small text-muted">В участок</div>
                                                                <div class="fw-semibold">@entry.TargetSectionName</div>
                                                            </div>
                                                        </div>
                                                    }
                                                    @if (entry.HasLabel)
                                                    {
                                                        <div class="d-flex gap-2 align-items-start">
                                                            <span class="d-inline-block rounded-circle bg-warning" style="width: 0.6rem; height: 0.6rem; margin-top: 0.35rem;"></span>
                                                            <div>
                                                                <div class="small text-muted">Ярлык</div>
                                                                <div class="fw-semibold">@entry.LabelNumber</div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        @if (entry.HasHours)
                                        {
                                            <div class="text-muted small mt-2">Часы: @entry.Hours!.Value.ToString("0.###")</div>
                                        }
                                        @if (entry.HasComment)
                                        {
                                            <div class="mt-2">
                                                <span class="fw-semibold">Комментарий:</span>
                                                <span>@entry.Comment</span>
                                            </div>
                                        }
                                        @if (entry.HasScrap && entry.Scrap is not null)
                                        {
                                            <div class="alert alert-warning mt-3 mb-0" role="alert">
                                                <div class="fw-semibold">@entry.Scrap.Type — @entry.Scrap.Quantity.ToString("0.###") шт</div>
                                                @if (entry.Scrap.HasComment)
                                                {
                                                    <div class="small text-muted">@entry.Scrap.Comment</div>
                                                }
                                            </div>
                                        }
                                        @if (entry.HasOperations)
                                        {
                                            <div class="mt-3">
                                                <div class="text-muted small fw-semibold text-uppercase">Операции</div>
                                                <ul class="small mt-2 mb-0">
                                                    @foreach (var operation in entry.Operations)
                                                    {
                                                        var parts = new List<string>();
                                                        parts.Add($"№ {operation.OpNumber}");
                                                        if (!string.IsNullOrWhiteSpace(operation.OperationName))
                                                        {
                                                            parts.Add(operation.OperationName);
                                                        }
                                                        if (!string.IsNullOrWhiteSpace(operation.SectionName))
                                                        {
                                                            parts.Add($"Вид работ: {operation.SectionName}");
                                                        }
                                                        if (operation.HasNormHours)
                                                        {
                                                            parts.Add($"Норматив: {operation.NormHours!.Value.ToString("0.###")}");
                                                        }
                                                        if (operation.HasHours)
                                                        {
                                                            parts.Add($"Часы: {operation.Hours!.Value.ToString("0.###")}");
                                                        }
                                                        if (operation.HasQuantityChange)
                                                        {
                                                            parts.Add($"Δ количество: {operation.QuantityChange!.Value.ToString("0.###")}");
                                                        }
                                                        <li>@string.Join(" • ", parts)</li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                        @if (hasActions)
                                        {
                                            <div class="mt-3 border-top pt-3">
                                                <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 js-history-actions">
                                                    <div class="d-flex flex-wrap gap-3">
                                                        @if (entry.Type == WipHistoryEntryType.Transfer && entry.HasVersions && entry.AuditId.HasValue)
                                                        {
                                                            <button type="button" class="btn btn-outline-danger btn-sm d-inline-flex align-items-center gap-2 js-history-transfer-revert" data-type="@entryType" @(entry.IsCancelled ? "disabled" : string.Empty)>
                                                                <i class="bi bi-arrow-counterclockwise fs-5" aria-hidden="true"></i>
                                                                <span class="fw-semibold">Отменить передачу</span>
                                                            </button>
                                                        }
                                                        @if (entry.Type == WipHistoryEntryType.Receipt && entry.HasVersions)
                                                        {
                                                            <button type="button" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2 js-history-receipt-revert" data-type="@entryType">
                                                                <i class="bi bi-arrow-clockwise fs-5" aria-hidden="true"></i>
                                                                <span class="fw-semibold">Восстановить приход</span>
                                                            </button>
                                                        }
                                                        @if (entry.Type == WipHistoryEntryType.Receipt && entry.CanDeleteReceipt)
                                                        {
                                                            <button type="button" class="btn btn-outline-danger btn-sm d-inline-flex align-items-center gap-2 js-history-receipt-delete" data-type="@entryType">
                                                                <i class="bi bi-trash3 fs-5" aria-hidden="true"></i>
                                                                <span class="fw-semibold">Удалить приход</span>
                                                            </button>
                                                        }
                                                    </div>
                                                    <div class="text-muted small">
                                                        @if (entry.Type == WipHistoryEntryType.Transfer && entry.HasVersions)
                                                        {
                                                            <div>Последний откат применит аудит текущей записи.</div>
                                                        }
                                                        @if (entry.Type == WipHistoryEntryType.Receipt)
                                                        {
                                                            <div>Восстановление использует сохранённые версии прихода.</div>
                                                            @if (entry.CanDeleteReceipt)
                                                            {
                                                                <div class="text-danger fw-semibold">Удаление окончательное: аудит сохранится, ярлыки будут отвязаны.</div>
                                                            }
                                                            else
                                                            {
                                                                <div class="text-muted">Удаление недоступно: по приходу уже есть передачи.</div>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </details>
                                }
                            </div>
                            <div class="text-md-end">
                                <div class="fw-semibold fs-4 js-history-quantity">@entry.Quantity.ToString("0.###") шт</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-light border shadow-sm">
        <div class="fw-semibold mb-1">За выбранный период данные отсутствуют.</div>
        <p class="mb-0">Попробуйте расширить диапазон дат или изменить типы операций.</p>
    </div>
}

<div class="modal fade" id="historyRevertModal" tabindex="-1" aria-labelledby="historyRevertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyRevertModalLabel">Восстановление прихода</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    Выберите нужную версию, чтобы вернуть приход к сохранённому состоянию. Перед подтверждением убедитесь, что количество не станет отрицательным.
                </div>
                <div id="historyRevertVersions" class="list-group small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="historyRevertConfirm" disabled>Восстановить</button>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-end mt-4">
    <a class="btn btn-link" asp-controller="Home" asp-action="Index">← На главную</a>
</div>
</div>

@section Scripts
{
    <script src="~/js/history.js" asp-append-version="true"></script>
}
</div>
    
