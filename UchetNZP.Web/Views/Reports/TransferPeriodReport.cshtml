@using System.Text.Encodings.Web
@model UchetNZP.Web.Models.TransferPeriodReportViewModel
@{
    ViewData["Title"] = "Отчёт по передаче НЗП за период";
}

<div class="page-header mb-4">
    <h1 class="display-5 fw-semibold">Отчёт по передаче НЗП за период</h1>
    <p class="lead mb-0">Просматривайте движения НЗП по дням и деталям, чтобы контролировать передачи между операциями.</p>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" autocomplete="off">
            <div class="col-md-3">
                <label class="form-label" for="transferPeriodFromInput">Период с</label>
                <input id="transferPeriodFromInput" class="form-control form-control-lg" type="date" name="from" value='@Model.Filter.From.ToString("yyyy-MM-dd")' />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="transferPeriodToInput">по</label>
                <input id="transferPeriodToInput" class="form-control form-control-lg" type="date" name="to" value='@Model.Filter.To.ToString("yyyy-MM-dd")' />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="transferPeriodSectionInput">Вид работ</label>
                <input id="transferPeriodSectionInput" class="form-control form-control-lg" type="text" name="section" value='@Model.Filter.Section' placeholder="Наименование или код вида работ" />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="transferPeriodPartInput">Деталь</label>
                <input id="transferPeriodPartInput" class="form-control form-control-lg" type="text" name="part" value='@Model.Filter.Part' placeholder="Наименование или обозначение детали" />
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="d-flex flex-wrap gap-3 w-100">
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1">Применить</button>
                    <a class="btn btn-secondary btn-lg flex-grow-1" asp-action="TransferPeriodReport" asp-route-from='@DateTime.Now.AddDays(-29).ToString("yyyy-MM-dd")' asp-route-to='@DateTime.Now.ToString("yyyy-MM-dd")'>Сбросить</a>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.HasData)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div class="d-flex flex-wrap gap-4">
                    <span>Деталей в отчёте: @Model.Items.Count</span>
                    <span>Дней в периоде: @Model.Dates.Count</span>
                </div>
                <a class="btn btn-success" asp-controller="Reports" asp-action="TransferPeriodReportExport" asp-route-from="@Model.Filter.From.ToString("yyyy-MM-dd")" asp-route-to="@Model.Filter.To.ToString("yyyy-MM-dd")" asp-route-part="@Model.Filter.Part" asp-route-section="@Model.Filter.Section">Экспорт в Excel</a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle" aria-describedby="transferPeriodReportCaption">
                    <caption id="transferPeriodReportCaption" class="visually-hidden">Результаты отчёта по передачам НЗП</caption>
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Деталь</th>
                            @foreach (var date in Model.Dates)
                            {
                                <th scope="col" class="text-center">@date.ToString("dd.MM.yyyy")</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <th scope="row" class="w-25">
                                    <div class="fw-semibold">@item.PartName</div>
                                    @if (!string.IsNullOrWhiteSpace(item.PartCode))
                                    {
                                        <div class="text-muted small">@item.PartCode</div>
                                    }
                                </th>
                                @foreach (var date in Model.Dates)
                                {
                                    <td>
                                        @if (item.Cells.TryGetValue(date, out var cellValues) && cellValues.Count > 0)
                                        {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var cell in cellValues)
                                                {
                                                    var encoded = string.IsNullOrWhiteSpace(cell)
                                                        ? string.Empty
                                                        : HtmlEncoder.Default.Encode(cell).Replace("\n", "<br />");
                                                    <li>@Html.Raw(encoded)</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-light border shadow-sm">
        <div class="fw-semibold mb-1">За выбранный период передачи не найдены.</div>
        <p class="mb-0">Измените диапазон дат или условия фильтра, чтобы получить данные.</p>
    </div>
}

<div class="d-flex justify-content-end mt-4">
    <a class="btn btn-link" asp-controller="Home" asp-action="Index">← Вернуться на главную</a>
</div>
