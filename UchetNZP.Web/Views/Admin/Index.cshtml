@using System.Text.Json
@model AdminIndexViewModel
@{
    ViewData["Title"] = "Администрирование";
}

<h1 class="mb-4">@ViewData["Title"]</h1>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">@Model.StatusMessage</div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
}

<form id="adminAntiForgery" class="d-none">
    @Html.AntiForgeryToken()
</form>

<div id="adminOptions" data-part-options='@Html.Raw(JsonSerializer.Serialize(Model.PartOptions))' data-operation-options='@Html.Raw(JsonSerializer.Serialize(Model.OperationOptions))' data-section-options='@Html.Raw(JsonSerializer.Serialize(Model.SectionOptions))'></div>

<ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="parts-tab" data-bs-toggle="tab" data-bs-target="#partsTab" type="button" role="tab" aria-controls="partsTab" aria-selected="true">Детали</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operationsTab" type="button" role="tab" aria-controls="operationsTab" aria-selected="false">Операции</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sections-tab" data-bs-toggle="tab" data-bs-target="#sectionsTab" type="button" role="tab" aria-controls="sectionsTab" aria-selected="false">Участки</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balancesTab" type="button" role="tab" aria-controls="balancesTab" aria-selected="false">Остатки</button>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">
    <div class="tab-pane fade show active" id="partsTab" role="tabpanel" aria-labelledby="parts-tab">
        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
        {
            FormId = "partsFilterForm",
            TargetTableId = "partsTable",
            Inputs = new[]
            {
                new AdminFilterInputViewModel("partSearch", "partSearch", "Поиск", Model.PartSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
            },
        })

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Детали</h2>
                <button type="button" class="btn btn-primary admin-create" data-entity="parts">Создать</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="partsTable"
                           class="table table-striped"
                           data-toggle="table"
                           data-unique-id="id"
                           data-pagination="true"
                           data-side-pagination="server"
                           data-page-size="10"
                           data-url="@Url.Action("GetPartsData", "Admin")"
                           data-sort-name="name"
                           data-sort-order="asc"
                           data-locale="ru-RU">
                        <thead>
                            <tr>
                                <th data-field="name" data-sortable="true">Название</th>
                                <th data-field="code" data-sortable="true">Код</th>
                                <th data-field="id" data-formatter="partsActionFormatter" data-align="right">Действия</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "partsActionTemplate", EntityKey = "parts" })
    </div>

    <div class="tab-pane fade" id="operationsTab" role="tabpanel" aria-labelledby="operations-tab">
        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
        {
            FormId = "operationsFilterForm",
            TargetTableId = "operationsTable",
            Inputs = new[]
            {
                new AdminFilterInputViewModel("operationSearch", "operationSearch", "Поиск", Model.OperationSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
            },
        })

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Операции</h2>
                <button type="button" class="btn btn-primary admin-create" data-entity="operations">Создать</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="operationsTable"
                           class="table table-striped"
                           data-toggle="table"
                           data-unique-id="id"
                           data-pagination="true"
                           data-side-pagination="server"
                           data-page-size="10"
                           data-url="@Url.Action("GetOperationsData", "Admin")"
                           data-sort-name="name"
                           data-sort-order="asc"
                           data-locale="ru-RU">
                        <thead>
                            <tr>
                                <th data-field="name" data-sortable="true">Название</th>
                                <th data-field="code" data-sortable="true">Код</th>
                                <th data-field="id" data-formatter="operationsActionFormatter" data-align="right">Действия</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "operationsActionTemplate", EntityKey = "operations" })
    </div>

    <div class="tab-pane fade" id="sectionsTab" role="tabpanel" aria-labelledby="sections-tab">
        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
        {
            FormId = "sectionsFilterForm",
            TargetTableId = "sectionsTable",
            Inputs = new[]
            {
                new AdminFilterInputViewModel("sectionSearch", "sectionSearch", "Поиск", Model.SectionSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
            },
        })

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Участки</h2>
                <button type="button" class="btn btn-primary admin-create" data-entity="sections">Создать</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="sectionsTable"
                           class="table table-striped"
                           data-toggle="table"
                           data-unique-id="id"
                           data-pagination="true"
                           data-side-pagination="server"
                           data-page-size="10"
                           data-url="@Url.Action("GetSectionsData", "Admin")"
                           data-sort-name="name"
                           data-sort-order="asc"
                           data-locale="ru-RU">
                        <thead>
                            <tr>
                                <th data-field="name" data-sortable="true">Название</th>
                                <th data-field="code" data-sortable="true">Код</th>
                                <th data-field="id" data-formatter="sectionsActionFormatter" data-align="right">Действия</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "sectionsActionTemplate", EntityKey = "sections" })
    </div>

    <div class="tab-pane fade" id="balancesTab" role="tabpanel" aria-labelledby="balances-tab">
        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
        {
            FormId = "balancesFilterForm",
            TargetTableId = "balancesTable",
            Inputs = new[]
            {
                new AdminFilterInputViewModel("wipBalancePartFilter", "wipBalancePartFilter", "Деталь", Model.WipBalancePartFilter?.ToString(), "select", cssClass: "col-md-4 col-lg-3", options: Model.PartOptions),
                new AdminFilterInputViewModel("wipBalanceSectionFilter", "wipBalanceSectionFilter", "Участок", Model.WipBalanceSectionFilter?.ToString(), "select", cssClass: "col-md-4 col-lg-3", options: Model.SectionOptions),
                new AdminFilterInputViewModel("wipBalanceSearch", "wipBalanceSearch", "Поиск", Model.WipBalanceSearch, placeholder: "Деталь, участок, операция или ярлык", cssClass: "col-md-4 col-lg-3"),
            },
        })

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Остатки</h2>
                <button type="button" class="btn btn-primary admin-create" data-entity="balances">Создать</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="balancesTable"
                           class="table table-striped"
                           data-toggle="table"
                           data-unique-id="id"
                           data-pagination="true"
                           data-side-pagination="server"
                           data-page-size="10"
                           data-url="@Url.Action("GetBalancesData", "Admin")"
                           data-sort-name="partName"
                           data-sort-order="asc"
                           data-locale="ru-RU">
                        <thead>
                            <tr>
                                <th data-field="partName" data-sortable="true">Деталь</th>
                                <th data-field="sectionName" data-sortable="true">Участок</th>
                                <th data-field="operationName" data-sortable="true">Операция</th>
                                <th data-field="operationLabel" data-sortable="true">Ярлык</th>
                                <th data-field="opNumber" data-sortable="true">№ операции</th>
                                <th data-field="quantity" data-sortable="true">Количество</th>
                                <th data-field="id" data-formatter="balancesActionFormatter" data-align="right">Действия</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "balancesActionTemplate", EntityKey = "balances" })
    </div>
</div>

<div class="modal fade" id="adminEntityModal" tabindex="-1" aria-labelledby="adminEntityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" id="adminEntityForm">
            <div class="modal-header">
                <h5 class="modal-title" id="adminEntityModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div id="adminEntityValidation" class="alert alert-danger d-none" role="alert"></div>
                <div id="adminEntityFields"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="partFormTemplate">
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" value="{{name}}" required />
        </div>
        <div class="col-md-6">
            <label class="form-label">Код</label>
            <input type="text" name="code" class="form-control" value="{{code}}" />
        </div>
    </div>
</script>

<script type="text/template" id="balanceFormTemplate">
    <div class="row g-3">
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Деталь</label>
            <select name="partId" class="form-select">{{partOptions}}</select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Участок</label>
            <select name="sectionId" class="form-select">{{sectionOptions}}</select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Операция</label>
            <select name="operationId" class="form-select">{{operationOptions}}</select>
        </div>
        <div class="col-md-3 col-lg-2">
            <label class="form-label">№ операции</label>
            <input type="number" name="opNumber" class="form-control" value="{{opNumber}}" min="0" required />
        </div>
        <div class="col-md-3 col-lg-2">
            <label class="form-label">Количество</label>
            <input type="number" name="quantity" class="form-control" step="0.01" value="{{quantity}}" min="0" required />
        </div>
    </div>
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/admin-index.js" asp-append-version="true"></script>
}
