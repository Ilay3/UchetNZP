@using System.Text.Json
@using UchetNZP.Shared
@model AdminIndexViewModel
@{
    ViewData["Title"] = "Администрирование";
}

<div class="row g-4">
    <div class="col-lg-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="h6 text-uppercase text-muted mb-3">Разделы</h2>
                <div class="nav flex-column nav-pills gap-2" id="adminTabs" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="parts-tab" data-bs-toggle="tab" data-bs-target="#partsTab" type="button" role="tab" aria-controls="partsTab" aria-selected="true" data-entity="parts">Детали</button>
                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operationsTab" type="button" role="tab" aria-controls="operationsTab" aria-selected="false" data-entity="operations">Операции</button>
                    <button class="nav-link" id="sections-tab" data-bs-toggle="tab" data-bs-target="#sectionsTab" type="button" role="tab" aria-controls="sectionsTab" aria-selected="false" data-entity="sections">Участки</button>
                    <button class="nav-link" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balancesTab" type="button" role="tab" aria-controls="balancesTab" aria-selected="false" data-entity="balances">Остатки</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-9">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <h1 class="mb-0">@ViewData["Title"]</h1>
            <span class="text-muted small" id="adminActiveEntityLabel"></span>
        </div>

        @if (!string.IsNullOrEmpty(Model.StatusMessage))
        {
            <div class="d-none" data-toast-message="@Model.StatusMessage" data-toast-variant="success"></div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="d-none" data-toast-message="@Model.ErrorMessage" data-toast-variant="danger"></div>
        }

        <form id="adminAntiForgery" class="d-none">
            @Html.AntiForgeryToken()
        </form>

        <div id="adminOptions" data-part-options='@Html.Raw(JsonSerializer.Serialize(Model.PartOptions))' data-operation-options='@Html.Raw(JsonSerializer.Serialize(Model.OperationOptions))' data-section-options='@Html.Raw(JsonSerializer.Serialize(Model.SectionOptions))'></div>

        <div class="card mb-4">
            <div class="card-body d-flex flex-wrap align-items-center gap-2">
                <span class="text-muted text-uppercase small">Быстрые действия</span>
                <button type="button" class="btn btn-primary admin-quick-create">Добавить</button>
                <button type="button" class="btn btn-outline-danger admin-quick-delete">Удалить</button>
                <button type="button" class="btn btn-outline-secondary admin-quick-export">Экспорт</button>
                <span class="text-muted small ms-auto" id="adminSelectionHint"></span>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-xl-8">
                <div class="tab-content" id="adminTabsContent">
                    <div class="tab-pane fade show active" id="partsTab" role="tabpanel" aria-labelledby="parts-tab">
                        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
                        {
                            FormId = "partsFilterForm",
                            TargetTableId = "partsTable",
                            Inputs = new[]
                            {
                                new AdminFilterInputViewModel("partSearch", "partSearch", "Поиск", Model.PartSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
                            },
                        })

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">Список деталей</h2>
                            </div>
                            <div class="card-body">
                                <div class="admin-table-wrapper position-relative">
                                    <div class="admin-table-loading d-flex" id="partsTableLoading" role="status" aria-live="polite">
                                        <div class="spinner-border text-primary" aria-hidden="true"></div>
                                        <span class="ms-2">Загрузка данных...</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table id="partsTable"
                                               class="table table-striped"
                                               data-toggle="table"
                                               data-unique-id="id"
                                               data-pagination="true"
                                               data-side-pagination="server"
                                               data-page-size="10"
                                               data-click-to-select="true"
                                               data-url="@Url.Action("GetPartsData", "Admin")"
                                               data-sort-name="name"
                                               data-sort-order="asc"
                                               data-locale="ru-RU">
                                            <thead>
                                                <tr>
                                                    <th data-checkbox="true"></th>
                                                    <th data-field="name" data-sortable="true">Название</th>
                                                    <th data-field="code" data-sortable="true">Код</th>
                                                    <th data-field="id" data-formatter="partsActionFormatter" data-align="right">Действия</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "partsActionTemplate", EntityKey = "parts" })
                    </div>

                    <div class="tab-pane fade" id="operationsTab" role="tabpanel" aria-labelledby="operations-tab">
                        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
                        {
                            FormId = "operationsFilterForm",
                            TargetTableId = "operationsTable",
                            Inputs = new[]
                            {
                                new AdminFilterInputViewModel("operationSearch", "operationSearch", "Поиск", Model.OperationSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
                            },
                        })

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">Список операций</h2>
                            </div>
                            <div class="card-body">
                                <div class="admin-table-wrapper position-relative">
                                    <div class="admin-table-loading d-flex" id="operationsTableLoading" role="status" aria-live="polite">
                                        <div class="spinner-border text-primary" aria-hidden="true"></div>
                                        <span class="ms-2">Загрузка данных...</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table id="operationsTable"
                                               class="table table-striped"
                                               data-toggle="table"
                                               data-unique-id="id"
                                               data-pagination="true"
                                               data-side-pagination="server"
                                               data-page-size="10"
                                               data-click-to-select="true"
                                               data-url="@Url.Action("GetOperationsData", "Admin")"
                                               data-sort-name="name"
                                               data-sort-order="asc"
                                               data-locale="ru-RU">
                                            <thead>
                                                <tr>
                                                    <th data-checkbox="true"></th>
                                                    <th data-field="name" data-sortable="true">Название</th>
                                                    <th data-field="code" data-sortable="true">Код</th>
                                                    <th data-field="id" data-formatter="operationsActionFormatter" data-align="right">Действия</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "operationsActionTemplate", EntityKey = "operations" })
                    </div>

                    <div class="tab-pane fade" id="sectionsTab" role="tabpanel" aria-labelledby="sections-tab">
                        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
                        {
                            FormId = "sectionsFilterForm",
                            TargetTableId = "sectionsTable",
                            Inputs = new[]
                            {
                                new AdminFilterInputViewModel("sectionSearch", "sectionSearch", "Поиск", Model.SectionSearch, placeholder: "Название или код", cssClass: "col-md-4 col-lg-3"),
                            },
                        })

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">Список участков</h2>
                            </div>
                            <div class="card-body">
                                <div class="admin-table-wrapper position-relative">
                                    <div class="admin-table-loading d-flex" id="sectionsTableLoading" role="status" aria-live="polite">
                                        <div class="spinner-border text-primary" aria-hidden="true"></div>
                                        <span class="ms-2">Загрузка данных...</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table id="sectionsTable"
                                               class="table table-striped"
                                               data-toggle="table"
                                               data-unique-id="id"
                                               data-pagination="true"
                                               data-side-pagination="server"
                                               data-page-size="10"
                                               data-click-to-select="true"
                                               data-url="@Url.Action("GetSectionsData", "Admin")"
                                               data-sort-name="name"
                                               data-sort-order="asc"
                                               data-locale="ru-RU">
                                            <thead>
                                                <tr>
                                                    <th data-checkbox="true"></th>
                                                    <th data-field="name" data-sortable="true">Название</th>
                                                    <th data-field="code" data-sortable="true">Код</th>
                                                    <th data-field="id" data-formatter="sectionsActionFormatter" data-align="right">Действия</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "sectionsActionTemplate", EntityKey = "sections" })
                    </div>

                    <div class="tab-pane fade" id="balancesTab" role="tabpanel" aria-labelledby="balances-tab">
                        @await Html.PartialAsync("_AdminFilterPanel", new AdminFilterPanelViewModel
                        {
                            FormId = "balancesFilterForm",
                            TargetTableId = "balancesTable",
                            Inputs = new[]
                            {
                                new AdminFilterInputViewModel("wipBalancePartFilter", "wipBalancePartFilter", "Деталь", Model.WipBalancePartFilter?.ToString(), "select", cssClass: "col-md-4 col-lg-3", options: Model.PartOptions),
                                new AdminFilterInputViewModel("wipBalanceSectionFilter", "wipBalanceSectionFilter", "Участок", Model.WipBalanceSectionFilter?.ToString(), "select", cssClass: "col-md-4 col-lg-3", options: Model.SectionOptions),
                                new AdminFilterInputViewModel("wipBalanceSearch", "wipBalanceSearch", "Поиск", Model.WipBalanceSearch, placeholder: "Деталь, участок, операция или ярлык", cssClass: "col-md-4 col-lg-3"),
                            },
                        })

                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">Список остатков</h2>
                            </div>
                            <div class="card-body">
                                <div class="admin-table-wrapper position-relative">
                                    <div class="admin-table-loading d-flex" id="balancesTableLoading" role="status" aria-live="polite">
                                        <div class="spinner-border text-primary" aria-hidden="true"></div>
                                        <span class="ms-2">Загрузка данных...</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table id="balancesTable"
                                               class="table table-striped"
                                               data-toggle="table"
                                               data-unique-id="id"
                                               data-pagination="true"
                                               data-side-pagination="server"
                                               data-page-size="10"
                                               data-click-to-select="true"
                                               data-url="@Url.Action("GetBalancesData", "Admin")"
                                               data-sort-name="partName"
                                               data-sort-order="asc"
                                               data-locale="ru-RU">
                                            <thead>
                                                <tr>
                                                    <th data-checkbox="true"></th>
                                                    <th data-field="partName" data-sortable="true">Деталь</th>
                                                    <th data-field="sectionName" data-sortable="true">Участок</th>
                                                    <th data-field="operationName" data-sortable="true">Операция</th>
                                                    <th data-field="operationLabel" data-sortable="true">Ярлык</th>
                                                    <th data-field="opNumberFormatted" data-sortable="true" data-sort-name="opNumber">№ операции</th>
                                                    <th data-field="quantity" data-sortable="true">Количество</th>
                                                    <th data-field="id" data-formatter="balancesActionFormatter" data-align="right">Действия</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @await Html.PartialAsync("_AdminTableActions", new AdminTableActionsViewModel { TemplateId = "balancesActionTemplate", EntityKey = "balances" })
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="card admin-detail-panel" id="adminEntityPanel">
                    <div class="card-header d-flex flex-column gap-1">
                        <h2 class="h5 mb-0" id="adminEntityPanelTitle">Форма</h2>
                        <span class="text-muted small" id="adminEntityPanelHint">Выберите запись в таблице или нажмите «Добавить».</span>
                    </div>
                    <form class="card-body" id="adminEntityForm">
                        <div id="adminEntityValidation" class="alert alert-danger d-none" role="alert"></div>
                        <div id="adminEntityFields"></div>
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-outline-secondary admin-form-reset">Очистить</button>
                            <button type="submit" class="btn btn-primary" data-loading-label="Сохранение...">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/template" id="partFormTemplate">
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" value="{{name}}" required />
        </div>
        <div class="col-md-6">
            <label class="form-label">Код</label>
            <input type="text" name="code" class="form-control" value="{{code}}" />
        </div>
    </div>
</script>

<script type="text/template" id="balanceFormTemplate">
    <div class="row g-3">
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Деталь</label>
            <select name="partId" class="form-select">{{partOptions}}</select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Участок</label>
            <select name="sectionId" class="form-select">{{sectionOptions}}</select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Операция</label>
            <select name="operationId" class="form-select">{{operationOptions}}</select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label class="form-label">Ярлык операции</label>
            <input type="text" name="operationLabel" class="form-control" value="{{operationLabel}}" placeholder="Код операции" />
            <div class="form-text">Если указан новый ярлык, он будет создан и связан с записью.</div>
        </div>
        <div class="col-md-3 col-lg-2">
            <label class="form-label">№ операции</label>
            <input type="text" name="opNumber" class="form-control" value="{{opNumber}}" inputmode="text" pattern="@OperationNumber.AllowedPattern" maxlength="16" required />
        </div>
        <div class="col-md-3 col-lg-2">
            <label class="form-label">Количество</label>
            <input type="number" name="quantity" class="form-control" step="0.01" value="{{quantity}}" min="0" required />
        </div>
    </div>
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/admin-index.js" asp-append-version="true"></script>
}
