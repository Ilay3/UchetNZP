@using System.Globalization
@model AdminIndexViewModel
@{
    ViewData["Title"] = "Администрирование";
}

<h1 class="mb-4">@ViewData["Title"]</h1>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">@Model.StatusMessage</div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
}

<section id="parts" class="mb-5">
    <h2 class="h4">Детали</h2>

    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-6 col-lg-4">
            <label for="partSearch" class="form-label">Поиск</label>
            <input type="text" id="partSearch" name="partSearch" value="@Model.PartSearch" class="form-control" placeholder="Название или код" />
        </div>
        <div class="col-md-3 col-lg-2">
            <button type="submit" class="btn btn-outline-primary w-100">Найти</button>
        </div>
        <div class="col-md-3 col-lg-2">
            <a class="btn btn-link w-100" href="@Url.Action("Index", new { operationSearch = Model.OperationSearch, sectionSearch = Model.SectionSearch, wipBalancePartFilter = Model.WipBalancePartFilter, wipBalanceSectionFilter = Model.WipBalanceSectionFilter, wipBalanceSearch = Model.WipBalanceSearch })">Сбросить</a>
        </div>
        @if (!string.IsNullOrEmpty(Model.OperationSearch))
        {
            <input type="hidden" name="operationSearch" value="@Model.OperationSearch" />
        }
        @if (!string.IsNullOrEmpty(Model.SectionSearch))
        {
            <input type="hidden" name="sectionSearch" value="@Model.SectionSearch" />
        }
        @if (Model.WipBalancePartFilter.HasValue)
        {
            <input type="hidden" name="wipBalancePartFilter" value="@Model.WipBalancePartFilter" />
        }
        @if (Model.WipBalanceSectionFilter.HasValue)
        {
            <input type="hidden" name="wipBalanceSectionFilter" value="@Model.WipBalanceSectionFilter" />
        }
        @if (!string.IsNullOrEmpty(Model.WipBalanceSearch))
        {
            <input type="hidden" name="wipBalanceSearch" value="@Model.WipBalanceSearch" />
        }
    </form>

    <div class="card mb-3">
        <div class="card-body">
            <h3 class="h5">Добавить деталь</h3>
            <form asp-action="CreatePart" method="post" class="row g-3">
                @Html.AntiForgeryToken()
                @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="col-md-5">
                    <label asp-for="PartInput.Name" class="form-label"></label>
                    <input asp-for="PartInput.Name" class="form-control" />
                    <span asp-validation-for="PartInput.Name" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="PartInput.Code" class="form-label"></label>
                    <input asp-for="PartInput.Code" class="form-control" />
                    <span asp-validation-for="PartInput.Code" class="text-danger"></span>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th style="width: 30%">Название</th>
                    <th style="width: 20%">Код</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var part in Model.Parts)
            {
                var formId = $"update-part-{part.Id}";
                <tr>
                    <td>
                        <input form="@formId" type="text" name="Name" value="@part.Name" class="form-control form-control-sm" required />
                    </td>
                    <td>
                        <input form="@formId" type="text" name="Code" value="@part.Code" class="form-control form-control-sm" />
                    </td>
                    <td class="text-end">
                        <form id="@formId" asp-action="UpdatePart" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="Id" value="@part.Id" />
                            <button type="submit" class="btn btn-primary btn-sm me-2" onclick="return confirm('Сохранить изменения детали?');">Сохранить</button>
                        </form>
                        <form asp-action="DeletePart" method="post" class="d-inline" onsubmit="return confirm('Удалить деталь? Это действие нельзя отменить.');">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="id" value="@part.Id" />
                            <button type="submit" class="btn btn-outline-danger btn-sm">Удалить</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</section>

<section id="operations" class="mb-5">
    <h2 class="h4">Операции</h2>

    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-6 col-lg-4">
            <label for="operationSearch" class="form-label">Поиск</label>
            <input type="text" id="operationSearch" name="operationSearch" value="@Model.OperationSearch" class="form-control" placeholder="Название или код" />
        </div>
        <div class="col-md-3 col-lg-2">
            <button type="submit" class="btn btn-outline-primary w-100">Найти</button>
        </div>
        <div class="col-md-3 col-lg-2">
            <a class="btn btn-link w-100" href="@Url.Action("Index", new { partSearch = Model.PartSearch, sectionSearch = Model.SectionSearch, wipBalancePartFilter = Model.WipBalancePartFilter, wipBalanceSectionFilter = Model.WipBalanceSectionFilter, wipBalanceSearch = Model.WipBalanceSearch })">Сбросить</a>
        </div>
        @if (!string.IsNullOrEmpty(Model.PartSearch))
        {
            <input type="hidden" name="partSearch" value="@Model.PartSearch" />
        }
        @if (!string.IsNullOrEmpty(Model.SectionSearch))
        {
            <input type="hidden" name="sectionSearch" value="@Model.SectionSearch" />
        }
        @if (Model.WipBalancePartFilter.HasValue)
        {
            <input type="hidden" name="wipBalancePartFilter" value="@Model.WipBalancePartFilter" />
        }
        @if (Model.WipBalanceSectionFilter.HasValue)
        {
            <input type="hidden" name="wipBalanceSectionFilter" value="@Model.WipBalanceSectionFilter" />
        }
        @if (!string.IsNullOrEmpty(Model.WipBalanceSearch))
        {
            <input type="hidden" name="wipBalanceSearch" value="@Model.WipBalanceSearch" />
        }
    </form>

    <div class="card mb-3">
        <div class="card-body">
            <h3 class="h5">Добавить операцию</h3>
            <form asp-action="CreateOperation" method="post" class="row g-3">
                @Html.AntiForgeryToken()
                @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="col-md-5">
                    <label asp-for="OperationInput.Name" class="form-label"></label>
                    <input asp-for="OperationInput.Name" class="form-control" />
                    <span asp-validation-for="OperationInput.Name" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="OperationInput.Code" class="form-label"></label>
                    <input asp-for="OperationInput.Code" class="form-control" />
                    <span asp-validation-for="OperationInput.Code" class="text-danger"></span>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th style="width: 30%">Название</th>
                    <th style="width: 20%">Код</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var operation in Model.Operations)
            {
                var formId = $"update-operation-{operation.Id}";
                <tr>
                    <td>
                        <input form="@formId" type="text" name="Name" value="@operation.Name" class="form-control form-control-sm" required />
                    </td>
                    <td>
                        <input form="@formId" type="text" name="Code" value="@operation.Code" class="form-control form-control-sm" />
                    </td>
                    <td class="text-end">
                        <form id="@formId" asp-action="UpdateOperation" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="Id" value="@operation.Id" />
                            <button type="submit" class="btn btn-primary btn-sm me-2" onclick="return confirm('Сохранить изменения операции?');">Сохранить</button>
                        </form>
                        <form asp-action="DeleteOperation" method="post" class="d-inline" onsubmit="return confirm('Удалить операцию? Это действие нельзя отменить.');">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="id" value="@operation.Id" />
                            <button type="submit" class="btn btn-outline-danger btn-sm">Удалить</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</section>

<section id="sections" class="mb-5">
    <h2 class="h4">Участки</h2>

    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-6 col-lg-4">
            <label for="sectionSearch" class="form-label">Поиск</label>
            <input type="text" id="sectionSearch" name="sectionSearch" value="@Model.SectionSearch" class="form-control" placeholder="Название или код" />
        </div>
        <div class="col-md-3 col-lg-2">
            <button type="submit" class="btn btn-outline-primary w-100">Найти</button>
        </div>
        <div class="col-md-3 col-lg-2">
            <a class="btn btn-link w-100" href="@Url.Action("Index", new { partSearch = Model.PartSearch, operationSearch = Model.OperationSearch, wipBalancePartFilter = Model.WipBalancePartFilter, wipBalanceSectionFilter = Model.WipBalanceSectionFilter, wipBalanceSearch = Model.WipBalanceSearch })">Сбросить</a>
        </div>
        @if (!string.IsNullOrEmpty(Model.PartSearch))
        {
            <input type="hidden" name="partSearch" value="@Model.PartSearch" />
        }
        @if (!string.IsNullOrEmpty(Model.OperationSearch))
        {
            <input type="hidden" name="operationSearch" value="@Model.OperationSearch" />
        }
        @if (Model.WipBalancePartFilter.HasValue)
        {
            <input type="hidden" name="wipBalancePartFilter" value="@Model.WipBalancePartFilter" />
        }
        @if (Model.WipBalanceSectionFilter.HasValue)
        {
            <input type="hidden" name="wipBalanceSectionFilter" value="@Model.WipBalanceSectionFilter" />
        }
        @if (!string.IsNullOrEmpty(Model.WipBalanceSearch))
        {
            <input type="hidden" name="wipBalanceSearch" value="@Model.WipBalanceSearch" />
        }
    </form>

    <div class="card mb-3">
        <div class="card-body">
            <h3 class="h5">Добавить участок</h3>
            <form asp-action="CreateSection" method="post" class="row g-3">
                @Html.AntiForgeryToken()
                @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="col-md-5">
                    <label asp-for="SectionInput.Name" class="form-label"></label>
                    <input asp-for="SectionInput.Name" class="form-control" />
                    <span asp-validation-for="SectionInput.Name" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="SectionInput.Code" class="form-label"></label>
                    <input asp-for="SectionInput.Code" class="form-control" />
                    <span asp-validation-for="SectionInput.Code" class="text-danger"></span>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th style="width: 30%">Название</th>
                    <th style="width: 20%">Код</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var sections in Model.Sections)
            {
                var formId = $"update-section-{sections.Id}";
                <tr>
                    <td>
                        <input form="@formId" type="text" name="Name" value="@sections.Name" class="form-control form-control-sm" required />
                    </td>
                    <td>
                        <input form="@formId" type="text" name="Code" value="@sections.Code" class="form-control form-control-sm" />
                    </td>
                    <td class="text-end">
                        <form id="@formId" asp-action="UpdateSection" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="Id" value="@sections.Id" />
                            <button type="submit" class="btn btn-primary btn-sm me-2" onclick="return confirm('Сохранить изменения участка?');">Сохранить</button>
                        </form>
                        <form asp-action="DeleteSection" method="post" class="d-inline" onsubmit="return confirm('Удалить участок? Это действие нельзя отменить.');">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="id" value="@sections.Id" />
                            <button type="submit" class="btn btn-outline-danger btn-sm">Удалить</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</section>

<section id="balances" class="mb-5">
    <h2 class="h4">Остатки</h2>

    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-4 col-lg-3">
            <label for="wipBalancePartFilter" class="form-label">Деталь</label>
            <select id="wipBalancePartFilter" name="wipBalancePartFilter" class="form-select">
                <option value="">Все детали</option>
                @foreach (var option in Model.PartOptions)
                {
                    var selected = Model.WipBalancePartFilter.HasValue && option.Value == Model.WipBalancePartFilter.Value.ToString() ? "selected" : null;
                    <option value="@option.Value" selected="@selected">@option.Text</option>
                }
            </select>
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="wipBalanceSectionFilter" class="form-label">Участок</label>
            <select id="wipBalanceSectionFilter" name="wipBalanceSectionFilter" class="form-select">
                <option value="">Все участки</option>
                @foreach (var option in Model.SectionOptions)
                {
                    var selected = Model.WipBalanceSectionFilter.HasValue && option.Value == Model.WipBalanceSectionFilter.Value.ToString() ? "selected" : null;
                    <option value="@option.Value" selected="@selected">@option.Text</option>
                }
            </select>
        </div>
        <div class="col-md-4 col-lg-3">
            <label for="wipBalanceSearch" class="form-label">Поиск</label>
            <input type="text" id="wipBalanceSearch" name="wipBalanceSearch" value="@Model.WipBalanceSearch" class="form-control" placeholder="Деталь, участок или операция" />
        </div>
        <div class="col-md-2 col-lg-1">
            <button type="submit" class="btn btn-outline-primary w-100">Фильтр</button>
        </div>
        <div class="col-md-2 col-lg-1">
            <a class="btn btn-link w-100" href="@Url.Action("Index", new { partSearch = Model.PartSearch, operationSearch = Model.OperationSearch, sectionSearch = Model.SectionSearch })">Сбросить</a>
        </div>
        @if (!string.IsNullOrEmpty(Model.PartSearch))
        {
            <input type="hidden" name="partSearch" value="@Model.PartSearch" />
        }
        @if (!string.IsNullOrEmpty(Model.OperationSearch))
        {
            <input type="hidden" name="operationSearch" value="@Model.OperationSearch" />
        }
        @if (!string.IsNullOrEmpty(Model.SectionSearch))
        {
            <input type="hidden" name="sectionSearch" value="@Model.SectionSearch" />
        }
    </form>

    <div class="card mb-3">
        <div class="card-body">
            <h3 class="h5">Добавить остаток</h3>
            <form asp-action="CreateWipBalance" method="post" class="row g-3">
                @Html.AntiForgeryToken()
                @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="col-md-4">
                    <label asp-for="WipBalanceInput.PartId" class="form-label"></label>
                    <select asp-for="WipBalanceInput.PartId" class="form-select" asp-items="Model.PartOptions">
                        <option value="">Выберите деталь</option>
                    </select>
                    <span asp-validation-for="WipBalanceInput.PartId" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="WipBalanceInput.SectionId" class="form-label"></label>
                    <select asp-for="WipBalanceInput.SectionId" class="form-select" asp-items="Model.SectionOptions">
                        <option value="">Выберите участок</option>
                    </select>
                    <span asp-validation-for="WipBalanceInput.SectionId" class="text-danger"></span>
                </div>
                <div class="col-md-2">
                    <label asp-for="WipBalanceInput.OpNumber" class="form-label"></label>
                    <input asp-for="WipBalanceInput.OpNumber" class="form-control" />
                    <span asp-validation-for="WipBalanceInput.OpNumber" class="text-danger"></span>
                </div>
                <div class="col-md-2">
                    <label asp-for="WipBalanceInput.Quantity" class="form-label"></label>
                    <input asp-for="WipBalanceInput.Quantity" class="form-control" />
                    <span asp-validation-for="WipBalanceInput.Quantity" class="text-danger"></span>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th style="width: 25%">Деталь</th>
                    <th style="width: 25%">Участок</th>
                    <th style="width: 15%">Операция</th>
                    <th style="width: 15%">Количество</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var balance in Model.WipBalances)
            {
                var formId = $"update-balance-{balance.Id}";
                <tr>
                    <td>
                        <select form="@formId" name="PartId" class="form-select form-select-sm">
                            @foreach (var option in Model.PartOptions)
                            {
                                var selected = option.Value == balance.PartId.ToString() ? "selected" : null;
                                <option value="@option.Value" selected="@selected">@option.Text</option>
                            }
                        </select>
                    </td>
                    <td>
                        <select form="@formId" name="SectionId" class="form-select form-select-sm">
                            @foreach (var option in Model.SectionOptions)
                            {
                                var selected = option.Value == balance.SectionId.ToString() ? "selected" : null;
                                <option value="@option.Value" selected="@selected">@option.Text</option>
                            }
                        </select>
                    </td>
                    <td>
                        <input form="@formId" type="number" name="OpNumber" value="@balance.OpNumber" class="form-control form-control-sm" min="0" />
                    </td>
                    <td>
                        <input form="@formId" type="number" step="0.01" name="Quantity" value="@balance.Quantity.ToString(CultureInfo.InvariantCulture)" class="form-control form-control-sm" min="0" />
                    </td>
                    <td class="text-end">
                        <form id="@formId" asp-action="UpdateWipBalance" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="Id" value="@balance.Id" />
                            <button type="submit" class="btn btn-primary btn-sm me-2" onclick="return confirm('Сохранить изменения остатка?');">Сохранить</button>
                        </form>
                        <form asp-action="DeleteWipBalance" method="post" class="d-inline" onsubmit="return confirm('Удалить остаток? Это действие нельзя отменить.');">
                            @Html.AntiForgeryToken()
                            @await Html.PartialAsync("_AdminFiltersHiddenFields", Model)
                            <input type="hidden" name="id" value="@balance.Id" />
                            <button type="submit" class="btn btn-outline-danger btn-sm">Удалить</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
